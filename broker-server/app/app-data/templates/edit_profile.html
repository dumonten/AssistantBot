{% extends "base.html" %}
{% block content %}
<div class="container" style="max-width:700px;">
  <h2>Редактирование профиля</h2>
  {% if not editable %}
    <p class="error" style="color:#c0392b;">У вас нет прав для редактирования этого профиля.</p>
    <div style="margin-top:12px;">
      <a href="/user/{{ user.id }}" class="button roboto-font secondary">Вернуться в профиль</a>
    </div>
  {% else %}
    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}
    <form class="profile-container" method="post" action="/user/{{ user.id }}/edit" enctype="multipart/form-data">
      <div class="profile-content">
        <div style="flex:0 0 180px;text-align:center;">
          {% if user.avatar %}
            <img id="avatarPreview" src="data:image/jpeg;base64,{{ user.avatar }}" alt="Avatar" style="width:160px;height:160px;object-fit:cover;border-radius:8px;border:1px solid #ddd;">
          {% else %}
            <img id="avatarPreview" src="{{ request.url_for('static', path='../resources/img/base_avatar.svg') }}" alt="Avatar" style="width:160px;height:160px;object-fit:cover;border-radius:8px;border:1px solid #ddd;background:#fff;padding:8px;">
          {% endif %}
          <div style="margin-top:10px;">
            <label for="avatarFile" class="button roboto-font">Загрузить</label>
            <input id="avatarFile" type="file" accept="image/*" style="display:none;">
          </div>
          <div style="margin-top:8px;">
            <button id="removeAvatarBtn" class="button roboto-font" type="button">Удалить</button>
          </div>
        </div>

        <!-- скрытое поле, куда JS запишет base64 -->
        <input type="hidden" id="avatar_b64" name="avatar_b64" value="">

        <label for="identifier">Никнейм / Имя</label>
        <input id="identifier" name="identifier" value="{{ user.identifier }}" type="text" required>

        <label for="email">E-mail</label>
        <input id="email" name="email" value="{{ user.email }}" type="email" required>

        <label for="password">Новый пароль (оставьте пустым, если не менять)</label>
        <input id="password" name="password" type="password" placeholder="Новый пароль">

        <label for="password_confirm">Подтверждение пароля</label>
        <input id="password_confirm" name="password_confirm" type="password" placeholder="Подтвердите пароль">

        <label for="birthday">Дата рождения</label>
        <input id="birthday" name="birthday" type="date" value="{{ user.birthday or '' }}">

        <label for="phone">Номер телефона</label>
        <input id="phone" name="phone" type="text" value="{{ user.phone or '' }}">

        <label for="bio">О себе</label>
        <textarea id="bio" name="bio" rows="4">{{ user.bio or '' }}</textarea>

        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
          <button class="button roboto-font secondary" type="button" onclick="window.location='/user/{{ user.id }}'">Отмена</button>
          <a class="button blue" href="/user/{{ user.id }}/2fa" style="display:flex;align-items:center;justify-content:center;">Настроить 2FA</a>
          <button class="button roboto-font" type="submit">Сохранить</button>
        </div>
      </div>
    </form>
  {% endif %}
</div>

<!-- Подключаем библиотеку browser-image-compression через CDN -->
<script src="https://cdn.jsdelivr.net/npm/browser-image-compression@1.0.13/dist/browser-image-compression.js"></script>
<script>
  const avatarFile = document.getElementById('avatarFile');
  const avatarB64Input = document.getElementById('avatar_b64');
  const preview = document.getElementById('avatarPreview');
  const removeBtn = document.getElementById('removeAvatarBtn');

   avatarFile.addEventListener('change', async () => {
    const file = avatarFile.files[0];
    if (!file) return;
    if (!file.type.startsWith('image/')) {
      alert('Пожалуйста, выберите изображение.');
      return;
    }

    // сначала читаем как Data URL
    const reader = new FileReader();
    reader.onload = async () => {
      const dataUrl = reader.result;
      const img = new Image();
      img.onload = async () => {
        // обрезаем к квадрату по центру
        const w = img.width;
        const h = img.height;
        const side = Math.min(w, h);
        const sx = (w - side) / 2;
        const sy = (h - side) / 2;

        // рисуем на canvas
        const canvas = document.createElement('canvas');
        canvas.width = side;
        canvas.height = side;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, sx, sy, side, side, 0, 0, side, side);

        // теперь canvas содержит квадратный отсечённый центр
        // получаем Blob из canvas
        canvas.toBlob(async (blob) => {
          try {
            // сжимаем blob используя browser-image-compression
            const options = {
              maxSizeMB: 0.752,
              maxWidthOrHeight: 1024,
              useWebWorker: true,
              initialQuality: 0.9,
              maxIteration: 10
            };
            const compressedBlob = await imageCompression(blob, options);
            const compressedDataUrl = await imageCompression.getDataUrlFromFile(compressedBlob);
            preview.src = compressedDataUrl;
            const comma = compressedDataUrl.indexOf(',');
            avatarB64Input.value = comma >= 0 ? compressedDataUrl.slice(comma + 1) : compressedDataUrl;
          } catch (err) {
            console.error(err);
            alert('Ошибка при сжатии изображения: ' + err.message);
          }
        }, 'image/jpeg');
      };
      img.src = dataUrl;
    };
    reader.readAsDataURL(file);
  });

  removeBtn.addEventListener('click', () => {
    avatarB64Input.value = '__DELETE__';
    preview.src = "{{ request.url_for('static', path='../resources/img/base_avatar.svg') }}";
  });
</script>


{% endblock %}